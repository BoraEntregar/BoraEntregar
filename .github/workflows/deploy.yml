name: Deploy to Hetzner VPS

on:
  push:
    branches:
      - main  # Deploy produÃ§Ã£o
      - dev   # Deploy desenvolvimento

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment based on branch
        id: set-env
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "service=backend-main" >> $GITHUB_OUTPUT
            echo "port=5001" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "service=backend-dev" >> $GITHUB_OUTPUT
            echo "port=5002" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e  # Parar em caso de erro

            echo "ğŸš€ Deploy BoraEntregar - Branch: ${{ github.ref_name }}"
            echo "ğŸŒ Ambiente: ${{ steps.set-env.outputs.environment }}"
            echo "ğŸ“¦ ServiÃ§o: ${{ steps.set-env.outputs.service }}"
            echo "========================================"

            # Navegar para o diretÃ³rio do projeto
            cd ~/BoraEntregar || exit 1

            # Fazer backup do .env antes de fazer pull
            if [ -f .env ]; then
              cp .env .env.backup
              echo "âœ… Backup do .env criado"
            fi

            # Atualizar cÃ³digo do repositÃ³rio
            echo "ğŸ“¥ Baixando atualizaÃ§Ãµes do GitHub..."
            git fetch --all
            git checkout ${{ github.ref_name }}
            git reset --hard origin/${{ github.ref_name }}
            echo "âœ… CÃ³digo atualizado (branch: ${{ github.ref_name }})"

            # Restaurar .env se existir backup
            if [ -f .env.backup ]; then
              mv .env.backup .env
              echo "âœ… .env restaurado"
            fi

            # Parar container antigo (se existir)
            echo "ğŸ›‘ Parando container ${{ steps.set-env.outputs.service }}..."
            docker-compose stop ${{ steps.set-env.outputs.service }} || true
            docker-compose rm -f ${{ steps.set-env.outputs.service }} || true

            # Rebuild e iniciar container
            echo "ğŸ”¨ Rebuilding container..."
            docker-compose build --no-cache ${{ steps.set-env.outputs.service }}

            echo "ğŸš€ Iniciando container..."
            docker-compose up -d ${{ steps.set-env.outputs.service }}

            # Aguardar container iniciar
            echo "â³ Aguardando container inicializar..."
            sleep 10

            # Verificar se container estÃ¡ rodando
            if docker-compose ps | grep -q "${{ steps.set-env.outputs.service }}.*Up"; then
              echo "âœ… Container ${{ steps.set-env.outputs.service }} estÃ¡ rodando!"
            else
              echo "âŒ Erro: Container nÃ£o iniciou corretamente"
              echo "ğŸ“‹ Logs do container:"
              docker-compose logs --tail=50 ${{ steps.set-env.outputs.service }}
              exit 1
            fi

            # Verificar saÃºde da API
            echo "ğŸ¥ Verificando health check..."
            sleep 5

            HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${{ steps.set-env.outputs.port }}/health || echo "000")

            if [ "$HEALTH_CHECK" = "200" ]; then
              echo "âœ… API respondendo corretamente!"
            else
              echo "âš ï¸  Health check retornou: $HEALTH_CHECK"
              echo "ğŸ“‹ Verificando logs..."
              docker-compose logs --tail=30 ${{ steps.set-env.outputs.service }}
            fi

            # Limpar imagens antigas
            echo "ğŸ§¹ Limpando imagens antigas..."
            docker image prune -f || true

            # Status final
            echo ""
            echo "========================================"
            echo "âœ… Deploy concluÃ­do!"
            echo "ğŸŒ Ambiente: ${{ steps.set-env.outputs.environment }}"
            echo "ğŸ“¦ Container: ${{ steps.set-env.outputs.service }}"
            echo "ğŸ”— Porta: ${{ steps.set-env.outputs.port }}"
            echo "========================================"

            # Mostrar status dos containers
            echo ""
            echo "ğŸ“Š Status dos containers:"
            docker-compose ps

            # Ãšltimos logs
            echo ""
            echo "ğŸ“‹ Ãšltimos logs (20 linhas):"
            docker-compose logs --tail=20 ${{ steps.set-env.outputs.service }}

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deploy realizado com sucesso!"
            echo "ğŸŒ Ambiente: ${{ steps.set-env.outputs.environment }}"
            echo "ğŸ“¦ Container: ${{ steps.set-env.outputs.service }}"
          else
            echo "âŒ Falha no deploy do ambiente ${{ steps.set-env.outputs.environment }}!"
          fi
